import{l as Ye}from"./index-Beb4J_my.js";import{d as He,r as m,db as $e,v as Ge,g as z,n as ie,E as Xe,a as r,c as b,o as d,b as t,w as l,e as u,u as s,f as _,h as i,x,t as g,F as j,y as ue,S as We,G as de,M as me,i as Qe}from"./index-DsliLC_t.js";import{j as Ze,d as et,t as tt}from"./flow-component-BA4K04df.js";import{d as Y}from"./dayjs.min-BC2oYI-_.js";import{n as lt}from"./cron-CvQBfdyS.js";import{I as at}from"./index-DsHLwFe9.js";const ot={style:{"margin-top":"-15px"}},nt={key:0,class:"next-exec-info"},st={class:"info-header"},rt={class:"info-content"},it={class:"time-list"},ut={class:"time-index"},dt={class:"index-number"},mt={class:"time-content"},pt={class:"time-text"},ct={key:0,class:"next-badge"},ft={class:"info-footer"},vt={class:"hint-text"},gt={style:{"text-align":"center"}},yt={style:{lineHeight:"30px"}},bt={key:0,style:{color:"var(--td-text-color-secondary)","font-size":"12px"}},_t={key:1,style:{color:"var(--td-text-color-secondary)","font-size":"12px"}},ht={class:"trigger-confirm-body"},xt={class:"confirm-info"},kt=He({__name:"job-property",props:{nodeData:Object,lf:Object||String,flowDetail:{type:Object,default:()=>({})},type:{type:String}},setup(y,{expose:pe,emit:ce}){const h=y,H=m(1),D=ce;let n=$e({name:"定时任务",cron:"0 0 */1 * * ?",description:"",status:"ENABLE",blockStrategy:"ABANDON_CURRENT",scheduleTimeType:"FIXED",fixedInterval:"1h"});const fe={name:[{required:!0,message:"名称必填"}],cron:[{required:!0,message:"触发时间表达式必填"},{validator:ve}],status:[{required:!0,message:"状态必填"}],retryType:[{required:!0,message:"重试类型必填"}],blockStrategy:[{required:!0,message:"阻塞策略必填"}],scheduleTimeType:[{required:!0,message:"调度时间类型必选"}],fixedInterval:[{required:!0,message:"固定间隔必选",validator:o=>n.scheduleTimeType==="FIXED"?!!o:!0}]};function ve(o){return o?Ye.isValidCron(o,{allowBlankDay:!0,allowSevenAsSunday:!0,seconds:!0,alias:!1})?{result:!0}:{result:!1,message:"无效的表达式格式"}:{result:!1,message:"请输入表达式"}}function ge(o){let e="";switch(o){case"10s":e="*/10 * * * * ?";break;case"1m":e="0 */1 * * * ?";break;case"30m":e="0 */30 * * * ?";break;case"1h":e="0 0 */1 * * ?";break;case"1am":e="0 0 1 * * ?";break;case"2am":e="0 0 2 * * ?";break;case"3am":e="0 0 3 * * ?";break;case"4am":e="0 0 4 * * ?";break;case"5am":e="0 0 5 * * ?";break;default:e=""}n.cron=e}const ye=()=>{h.lf.setProperties(h.nodeData.id,{...n})},be=o=>{o.validateResult===!0&&(ye(),D("closed"))},$=m(null);function _e(){$.value.submit()}const G=()=>{D("closed")};Ge(()=>{Object.assign(n,h.nodeData.properties)}),pe({cancelFunc:G,clickFormSubmit:_e});function he(o){switch(o){case"RUNNING":return"primary";case"SUCCESS":return"success";case"CANCELED":return"warning";case"FAILED":return"danger";default:return"primary"}}const X=[{value:"RUNNING",label:"运行中"},{value:"SUCCESS",label:"执行完毕"},{value:"FAILED",label:"失败"},{value:"CANCELED",label:"已取消"}],W=m([]),xe=[{title:"链路",fixed:"left",width:160,ellipsis:!0,align:"left",colKey:"requestId"},{title:"运行实例",width:150,ellipsis:!0,colKey:"instanceId"},{title:"状态",width:110,ellipsis:!0,colKey:"status"},{title:"开始时间",width:180,ellipsis:!0,colKey:"createTime"},{title:"完成时间",width:180,ellipsis:!0,colKey:"finishTime"},{title:"耗时(ms)",width:100,ellipsis:!0,colKey:"cost"},{title:"调度方式",width:110,ellipsis:!0,colKey:"triggerType"},{align:"center",fixed:"right",width:60,colKey:"op",title:z("components.commonTable.operation")}],ke=ie(()=>xe.filter(o=>o.colKey!=="op"||Xe(["data:flow:publish"]))),k=m({current:1,pageSize:10,total:0,pageSizeOptions:[10,50,100]}),F=m(!1),Ce=o=>{k.value=o,I()},Q={requestId:null,status:null,startCreateTime:null,endCreateTime:null,instanceId:null},c=m(Q);function I(){F.value=!0,Ze({query:{flowCode:h.flowDetail.code,componentCode:h.nodeData.id,...c.value},page:{current:k.value.current,size:k.value.pageSize},orders:[]}).then(o=>{o&&(W.value=o.records,k.value.total=o.total)}).finally(()=>{F.value=!1})}async function Te(o){o===3?(D("changeDrawerSize",750),I()):o===2?(D("resetDrawerSize"),q.value=!0,await ee(),q.value=!1):D("resetDrawerSize")}const N=m(!1),C=m(null),Ve=ie(()=>C.value?`确认删除 ${C.value.requestId} 任务日志？`:""),De=()=>{C.value=null},Ie=()=>{et({logId:C.value.id,flowId:h.flowDetail.id}).then(o=>{o&&(me.success("删除成功"),I())}).finally(()=>{N.value=!1,C.value=null})},Ee=o=>{C.value=o.row,N.value=!0},Z=m({前7天:Y().subtract(6,"day").toDate(),前3天:Y().subtract(2,"day").toDate(),今天:Y().toDate()}),we=o=>{c.value=Q,k.value.current=1,I()},U=m(!0),M=m(!1),E=m(!1),Se=async()=>{E.value=!0},Ne=()=>{E.value=!1},Ue=async()=>{M.value=!0,tt({flowId:h.flowDetail.id,componentCode:h.nodeData.id,async:U.value,args:T.value.reduce((o,e)=>(e.key&&(o[e.key]=e.value),o),{})}).then(o=>{o&&me.success(`调度成功, 运行实例: ${o.instanceId}, 唯一标识: ${o.requestId}, 可前往调度日志查看详情。`,3e3)}).finally(()=>{M.value=!1,E.value=!1})},L=m([]),P=m(!1),q=m(!1),Le=o=>({"0 */1 * * * ?":"每隔 1 分钟","0 */5 * * * ?":"每隔 5 分钟","0 */10 * * * ?":"每隔 10 分钟","0 */30 * * * ?":"每隔 30 分钟","0 0 */1 * * ?":"每隔 1 小时","0 0 1 * * ?":"每天凌晨 1 点","0 0 2 * * ?":"每天凌晨 2 点","0 0 3 * * ?":"每天凌晨 3 点","0 0 4 * * ?":"每天凌晨 4 点","0 0 5 * * ?":"每天凌晨 5 点"})[o]||"自定义",ee=async()=>{n.cron&&await lt({param:n.cron}).then(o=>{o?L.value=o.slice(0,4):L.value=[]}).finally(()=>{})},Ae=async()=>{P.value=!0,await ee(),P.value=!1},T=m([{key:"",value:""}]);function Re(){T.value.push({key:"",value:""})}function Oe(o){T.value.splice(T.value.indexOf(o),1)}return(o,e)=>{const w=r("t-input"),f=r("t-form-item"),A=r("t-radio"),te=r("t-radio-group"),v=r("t-option"),B=r("t-select"),ze=r("t-switch"),Fe=r("t-divider"),Me=r("t-textarea"),le=r("t-form"),J=r("t-tab-panel"),R=r("t-icon"),S=r("t-tag"),ae=r("t-link"),oe=r("t-loading"),Pe=r("t-input-group"),qe=r("t-empty"),O=r("t-space"),K=r("t-button"),V=r("t-col"),ne=r("t-date-picker"),se=r("t-row"),Be=r("t-tooltip"),Je=r("t-table"),re=r("t-dialog"),Ke=r("t-tabs");return d(),b("div",ot,[t(Ke,{modelValue:H.value,"onUpdate:modelValue":e[14]||(e[14]=a=>H.value=a),onChange:Te},{default:l(()=>[t(J,{value:1,"destroy-on-hide":!1},{label:l(()=>[...e[16]||(e[16]=[i(" 配置 ",-1)])]),default:l(()=>[e[22]||(e[22]=u("br",null,null,-1)),t(le,{ref_key:"form",ref:$,rules:fe,data:s(n),colon:!0,onReset:G,onSubmit:be},{default:l(()=>[t(f,{label:"名称",name:"name"},{default:l(()=>[t(w,{modelValue:s(n).name,"onUpdate:modelValue":e[0]||(e[0]=a=>s(n).name=a),readonly:y.type==="publish",placeholder:"请输入内容"},null,8,["modelValue","readonly"])]),_:1}),t(f,{label:"时间类型",name:"scheduleTimeType"},{default:l(()=>[t(te,{modelValue:s(n).scheduleTimeType,"onUpdate:modelValue":e[1]||(e[1]=a=>s(n).scheduleTimeType=a),disabled:y.type==="publish"},{default:l(()=>[t(A,{value:"FIXED"},{default:l(()=>[...e[17]||(e[17]=[i("固定时间",-1)])]),_:1}),t(A,{value:"EXPRESSION"},{default:l(()=>[...e[18]||(e[18]=[i("自定义",-1)])]),_:1})]),_:1},8,["modelValue","disabled"])]),_:1}),s(n).scheduleTimeType==="EXPRESSION"?(d(),_(f,{key:0,label:"触发时间",name:"cron"},{default:l(()=>[t(w,{modelValue:s(n).cron,"onUpdate:modelValue":e[2]||(e[2]=a=>s(n).cron=a),readonly:y.type==="publish",placeholder:"请输入触发时间表达式"},null,8,["modelValue","readonly"])]),_:1})):(d(),_(f,{key:1,label:"间隔",name:"fixedInterval"},{default:l(()=>[t(B,{modelValue:s(n).fixedInterval,"onUpdate:modelValue":e[3]||(e[3]=a=>s(n).fixedInterval=a),readonly:y.type==="publish",placeholder:"请选择固定间隔",style:{width:"100%"},onChange:ge},{default:l(()=>[t(v,{value:"10s",label:"每隔 10 秒"}),t(v,{value:"1m",label:"每隔 1 分钟"}),t(v,{value:"30m",label:"每隔 30 分钟"}),t(v,{value:"1h",label:"每隔 1 小时"}),t(v,{value:"1am",label:"每天凌晨 1 点"}),t(v,{value:"2am",label:"每天凌晨 2 点"}),t(v,{value:"3am",label:"每天凌晨 3 点"}),t(v,{value:"4am",label:"每天凌晨 4 点"}),t(v,{value:"5am",label:"每天凌晨 5 点"})]),_:1},8,["modelValue","readonly"])]),_:1})),t(f,{label:"状态",name:"status"},{default:l(()=>[t(ze,{modelValue:s(n).status,"onUpdate:modelValue":e[4]||(e[4]=a=>s(n).status=a),"before-change":()=>y.type!=="publish",customValue:["ENABLE","DISABLE"]},null,8,["modelValue","before-change"])]),_:1}),t(Fe,null,{default:l(()=>[...e[19]||(e[19]=[i("其他配置",-1)])]),_:1}),t(f,{label:"阻塞策略",name:"blockStrategy"},{default:l(()=>[t(B,{modelValue:s(n).blockStrategy,"onUpdate:modelValue":e[5]||(e[5]=a=>s(n).blockStrategy=a),readonly:y.type==="publish",placeholder:"请选择阻塞策略",style:{width:"100%"}},{default:l(()=>[t(v,{value:"BEFORE_INTERRUPTION",label:"中断之前任务"},{default:l(()=>[...e[20]||(e[20]=[i("中断之前任务",-1)])]),_:1}),t(v,{value:"ABANDON_CURRENT",label:"丢弃后续任务"},{default:l(()=>[...e[21]||(e[21]=[i("丢弃后续任务",-1)])]),_:1})]),_:1},8,["modelValue","readonly"])]),_:1}),t(f,{label:"描述",prop:"description"},{default:l(()=>[t(Me,{modelValue:s(n).description,"onUpdate:modelValue":e[6]||(e[6]=a=>s(n).description=a),readonly:y.type==="publish",rows:4},null,8,["modelValue","readonly"])]),_:1})]),_:1},8,["data"])]),_:1}),t(J,{value:2,"destroy-on-hide":!1},{label:l(()=>[...e[23]||(e[23]=[i(" 调度 ",-1)])]),default:l(()=>[e[32]||(e[32]=u("br",null,null,-1)),t(O,{direction:"vertical",style:{width:"100%"}},{default:l(()=>[t(oe,{loading:q.value,size:"small"},{default:l(()=>[L.value.length>0?(d(),b("div",nt,[u("div",st,[t(R,{loadDefaultIcons:!1,name:"time",style:{color:"var(--td-brand-color)"},size:"18px"}),e[24]||(e[24]=u("span",{class:"title"},"下次执行时间",-1)),s(n).cron?(d(),_(S,{key:0,size:"small",theme:"primary",variant:"light"},{default:l(()=>[i(g(Le(s(n).cron)),1)]),_:1})):x("",!0)]),u("div",rt,[u("div",it,[(d(!0),b(j,null,ue(L.value,(a,p)=>(d(),b("div",{key:p,class:We(["time-item",{"first-item":p===0}])},[u("div",ut,[u("span",dt,g(p+1),1)]),u("div",mt,[u("div",pt,g(a),1),p===0?(d(),b("div",ct,"即将执行")):x("",!0)])],2))),128))])]),u("div",ft,[t(oe,{loading:P.value,size:"small"},{default:l(()=>[t(ae,{theme:"primary",size:"small",onClick:Ae},{default:l(()=>[t(R,{loadDefaultIcons:!1,name:"refresh",size:"14px",style:{"margin-right":"4px"}}),e[25]||(e[25]=i(" 刷新时间 ",-1))]),_:1})]),_:1},8,["loading"]),u("span",vt,"基于当前表达式: "+g(s(n).cron),1)])])):x("",!0)]),_:1},8,["loading"]),y.type==="publish"?(d(),b(j,{key:0},[u("div",gt,[(d(!0),b(j,null,ue(T.value,a=>(d(),_(Pe,{separate:"",style:{"margin-bottom":"5px"}},{default:l(()=>[t(w,{placeholder:"参数名称",modelValue:a.key,"onUpdate:modelValue":p=>a.key=p,style:{width:"178px"}},null,8,["modelValue","onUpdate:modelValue"]),e[27]||(e[27]=u("div",{style:{lineHeight:"32px",height:"32px",color:"var(--td-text-color-secondary)"}}," -  ",-1)),t(w,{placeholder:"参数值/表达式",modelValue:a.value,"onUpdate:modelValue":p=>a.value=p,style:{width:"178px"}},null,8,["modelValue","onUpdate:modelValue"]),u("div",yt,[e[26]||(e[26]=i("   ",-1)),t(R,{loadDefaultIcons:!1,style:{color:"var(--td-text-color-secondary)",cursor:"pointer"},name:"minus-circle",onClick:p=>Oe(a)},null,8,["onClick"])])]),_:2},1024))),256)),T.value.length===0?(d(),_(qe,{key:0,title:"暂无参数"})):x("",!0),u("div",{onClick:e[7]||(e[7]=a=>Re()),style:{border:"1px dashed var(--td-text-color-placeholder)",height:"25px",color:"var(--td-text-color-secondary)","border-radius":"4px",cursor:"pointer",width:"80%",margin:"5px auto"}},[t(R,{loadDefaultIcons:!1,name:"add-circle"}),e[28]||(e[28]=u("br",null,null,-1))])]),t(O,null,{default:l(()=>[t(te,{modelValue:U.value,"onUpdate:modelValue":e[8]||(e[8]=a=>U.value=a),size:"small"},{default:l(()=>[t(A,{value:!1},{default:l(()=>[...e[29]||(e[29]=[i("同步调度",-1)])]),_:1}),t(A,{value:!0},{default:l(()=>[...e[30]||(e[30]=[i("异步调度",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(O,{align:"center"},{default:l(()=>[U.value===!0?(d(),b("span",bt," 提交调度请求后立即返回，后台异步执行任务，不阻塞当前请求。 ")):(d(),b("span",_t," 提交调度请求后需等待任务执行完成，可能会耗时较长导致请求超时，请求状态可在「调度日志」中查看。 "))]),_:1}),t(K,{theme:"primary",onClick:Se},{default:l(()=>[...e[31]||(e[31]=[i(" 调度一次 ",-1)])]),_:1})],64)):x("",!0)]),_:1})]),_:1}),t(J,{value:3,"destroy-on-hide":!1},{label:l(()=>[...e[33]||(e[33]=[i(" 调度日志 ",-1)])]),default:l(()=>[e[35]||(e[35]=u("br",null,null,-1)),t(le,{data:c.value,"label-width":80,colon:"",onReset:we,onSubmit:I},{default:l(()=>[t(se,null,{default:l(()=>[t(V,{span:10},{default:l(()=>[t(se,{gutter:[24,24]},{default:l(()=>[t(V,{span:6},{default:l(()=>[t(f,{label:"链路编码",name:"requestId"},{default:l(()=>[t(w,{modelValue:c.value.requestId,"onUpdate:modelValue":e[9]||(e[9]=a=>c.value.requestId=a),class:"form-item-content",type:"search",placeholder:"请输入链路编码",style:{minWidth:"134px"}},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:6},{default:l(()=>[t(f,{label:"状态",name:"status"},{default:l(()=>[t(B,{modelValue:c.value.status,"onUpdate:modelValue":e[10]||(e[10]=a=>c.value.status=a),style:{display:"inline-block"},class:"form-item-content",options:X,placeholder:"请选择",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),t(V,{span:6},{default:l(()=>[t(f,{label:"开始时间",name:"startCreateTime"},{default:l(()=>[t(ne,{"enable-time-picker":"","allow-input":"",clearable:"","default-time":"00:00:00",presets:Z.value,style:{width:"100%"},modelValue:c.value.startCreateTime,"onUpdate:modelValue":e[11]||(e[11]=a=>c.value.startCreateTime=a),format:"YYYY-MM-DD HH:mm:ss"},null,8,["presets","modelValue"])]),_:1})]),_:1}),t(V,{span:6},{default:l(()=>[t(f,{label:"结束时间",name:"endCreateTime"},{default:l(()=>[t(ne,{"enable-time-picker":"","allow-input":"",clearable:"","default-time":"23:59:59",presets:Z.value,style:{width:"100%"},modelValue:c.value.endCreateTime,"onUpdate:modelValue":e[12]||(e[12]=a=>c.value.endCreateTime=a),format:"YYYY-MM-DD HH:mm:ss"},null,8,["presets","modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(V,{span:2,class:"operation-container"},{default:l(()=>[s(de)("data:source:list")?(d(),_(K,{key:0,theme:"primary",type:"submit",style:{marginLeft:"var(--td-comp-margin-s)"}},{default:l(()=>[i(g(s(z)("components.commonTable.query")),1)]),_:1})):x("",!0),t(K,{type:"reset",variant:"base",theme:"default"},{default:l(()=>[i(g(s(z)("components.commonTable.reset")),1)]),_:1})]),_:1})]),_:1})]),_:1},8,["data"]),t(Je,{data:W.value,columns:ke.value,"row-key":"id","vertical-align":"top",hover:!0,pagination:k.value,loading:F.value,onPageChange:Ce},{status:l(({row:a})=>[a.status==="FAILED"?(d(),_(Be,{key:0,content:a.exception.length>600?a.exception.substring(0,600)+"...":a.exception,theme:"danger"},{default:l(()=>[t(S,{theme:"danger",variant:"light"},{default:l(()=>[e[34]||(e[34]=i(" 失败 ",-1)),t(s(at),{name:"help-circle",size:"15px",style:{"margin-right":"-2px"}})]),_:1})]),_:1},8,["content"])):(d(),_(S,{key:1,theme:he(a.status),variant:"light"},{default:l(()=>{var p;return[i(g((p=X.find(je=>je.value===a.status))==null?void 0:p.label),1)]}),_:2},1032,["theme"]))]),triggerType:l(({row:a})=>[t(S,{theme:a.triggerType==="MANUAL"?"primary":"success",variant:"light"},{default:l(()=>[i(g(a.triggerType==="MANUAL"?"手动执行":a.triggerType==="SCHEDULED"?"定时触发":a.triggerType??"定时触发"),1)]),_:2},1032,["theme"])]),op:l(a=>[t(O,null,{default:l(()=>[s(de)("data:flow:publish")?(d(),_(ae,{key:0,theme:"danger",onClick:p=>Ee(a)},{default:l(()=>[i(g(s(z)("pages.listBase.delete")),1)]),_:1},8,["onClick"])):x("",!0)]),_:2},1024)]),_:1},8,["data","columns","pagination","loading"]),t(re,{width:380,visible:N.value,"onUpdate:visible":e[13]||(e[13]=a=>N.value=a),header:"删除日志记录？",body:Ve.value,"on-cancel":De,onConfirm:Ie},null,8,["visible","body"])]),_:1})]),_:1},8,["modelValue"]),t(re,{visible:E.value,"onUpdate:visible":e[15]||(e[15]=a=>E.value=a),header:"确认执行","confirm-loading":M.value,"on-cancel":Ne,onConfirm:Ue,width:"360"},{default:l(()=>[u("div",ht,[u("div",xt,[u("span",null,[i("确认立即执行一次「"+g(s(n).name)+"」任务？手动执行非强制运行，会使用配置中阻塞策略(",1),t(S,{size:"small",theme:"primary",variant:"light"},{default:l(()=>[i(g(s(n).blockStrategy==="BEFORE_INTERRUPTION"?"中断之前任务":"丢弃后续任务"),1)]),_:1}),e[36]||(e[36]=i(")运行。",-1))])])])]),_:1},8,["visible","confirm-loading"])])}}}),wt=Qe(kt,[["__scopeId","data-v-00e63e16"]]);export{wt as default};
