import{d as Fe,l as Ke,r as d,db as $e,v as Ge,g as K,n as M,E as oe,a as m,c as $,o as f,b as a,w as o,e as E,u as l,f as c,x as g,F as ne,y as re,h as s,t as k,G as _,M as V,i as Ze}from"./index-DsliLC_t.js";import{g as je,l as Qe}from"./source-C6q21X3i.js";import{a as We,b as Ye,c as Xe,s as Je,e as el,f as ll}from"./flow-component-BA4K04df.js";const tl={style:{"margin-top":"-15px"}},al=Fe({__name:"debezium-property",props:{nodeData:Object,lf:Object||String,flowDetail:{type:Object,default:()=>({})},type:{type:String}},setup(se,{expose:ie,emit:ue}){const de=Ke(),{id:me,type:u}=de.currentRoute.value.query,h=ue,p=se,G=d(1);let n=$e({name:"实时数据监听",datasourceCode:null,description:"",status:"ENABLE",schemas:[],tables:"",operations:["READ","CREATE","UPDATE","DELETE"],startStrategy:"AUTO",savePoint:"",savePointInterval:5e3,savePointDuration:10,databaseServerId:Be(),listenerServerName:null,maxBatchSize:2048,datasourceName:null,datasourceType:null,threadNumber:null,connectionTimeZone:"GMT+08:00"});const pe={name:[{required:!0}],datasourceCode:[{required:!0}],status:[{required:!0}],schemas:[{required:!0}],tables:[{required:!0},{validator:fe}],maxBatchSize:[{required:!0}],operations:[{required:!0}],startStrategy:[{required:!0}],savePointInterval:[{required:!0}],savePointDuration:[{required:!0}],listenerServerName:[{required:!0}],connectionTimeZone:[{required:!0},{pattern:/^(GMT|UTC)[+-](0\d|1[0-2]):([0-5]\d)$/,message:"时区格式应为 GMT±HH:MM（如 GMT+08:00）"}],savePoint:[{required:!0}]};function fe(r){if(!r)return{result:!1,message:"请输入表名"};const e=r.split(","),b=new Set;return e.every(v=>{const y=v.trim();if(!y||!y.includes(".")||y.split(".").length!==2||y.startsWith(".")||y.endsWith("."))return!1;const[U]=y.split(".");return n.schemas.includes(U)?!0:(b.add(U),!1)})?{result:!0}:b.size>0?{result:!1,message:`未选择的库: ${Array.from(b).join(", ")}`}:{result:!1,message:"正确格式为（db1.table1,db2.table2）"}}const ve=()=>{p.lf.setProperties(p.nodeData.id,{...n})},be=r=>{r.validateResult===!0&&(ve(),h("closed"))},Z=d(null);function ye(){Z.value.submit()}const j=()=>{h("closed")};async function ce(){await je({query:{types:["MySQL","Oracle","PostgreSQL","MongoDB","SQLServer"],status:"ENABLE"},page:{current:1,size:9999},orders:[]}).then(r=>{if(r){const{records:e}=r;Q.value=e,e.forEach(b=>{if(p.nodeData.properties.datasourceCode===b.code){W(b);return}})}}),Object.assign(n,p.nodeData.properties)}Ge(()=>{ce()}),ie({cancelFunc:j,clickFormSubmit:ye});const Q=d([]),B=d([]);function W(r){n.datasourceName=r.name,n.datasourceType=r.type,B.value=[],Qe({id:r.id}).then(e=>{e&&(B.value=e)})}const Y=d([]),ge=[{title:"保存点编码",fixed:"left",width:160,ellipsis:!0,align:"left",colKey:"savePoint"},{title:"时间",width:110,ellipsis:!0,colKey:"createTime"},{align:"center",fixed:"right",width:40,colKey:"op",title:K("components.commonTable.operation")}],Se=M(()=>ge.filter(r=>r.colKey!=="op"||oe(["data:flow:publish"]))),w=d({current:1,pageSize:10,total:0}),q=d(!1),Ce=r=>{w.value=r,L()},Ve=r=>{D.value=r.row,A.value=!0},A=d(!1),D=d(null),he=M(()=>D.value?`删除后，${D.value.savePoint}的保存点数据将被清除，且无法恢复`:""),we=()=>{X()},De=()=>{We({savePointId:D.value.id,flowId:p.flowDetail.id}).then(r=>{r&&(V.success("删除成功"),X(),L()),A.value=!1})},X=()=>{D.value=-1};function L(){q.value=!0,Ye({query:{flowCode:p.flowDetail.code,componentCode:p.nodeData.id},page:{current:w.value.current,size:w.value.pageSize},orders:[]}).then(r=>{r&&(Y.value=r.records,w.value.total=r.total)}).finally(()=>{q.value=!1})}const P=d(!1),Pe=()=>{P.value=!1},Te=()=>{Xe({flowId:p.flowDetail.id,componentCode:p.nodeData.id}).then(r=>{r&&(V.success("保存点已清空"),L()),P.value=!1})};function Ue(){if(!_("data:flow:publish")){V.error("无权限访问");return}P.value=!0}const O=d([]),xe=[{title:"变更内容",width:160,ellipsis:!0,colKey:"schemaLine"},{title:"创建时间",width:110,ellipsis:!0,colKey:"createTime"},{align:"center",fixed:"right",width:40,colKey:"op",title:K("components.commonTable.operation")}],Ee=M(()=>xe.filter(r=>r.colKey!=="op"||oe(["data:flow:publish"]))),S=d({current:1,pageSize:10,total:0}),R=d(!1),ke=r=>{S.value=r,H()},H=()=>{R.value=!0,Je({query:{flowCode:p.flowDetail.code,componentCode:p.nodeData.id},page:{current:S.value.current,size:S.value.pageSize},orders:[]}).then(r=>{r?(O.value=r.records,S.value.total=r.total):(O.value=[],S.value.total=0)}).finally(()=>{R.value=!1})},I=d(!1),C=d(null),Ae=M(()=>C.value?`确认删除 ${C.value.id} 的变更记录？此操作可能会影响正常的同步任务，请谨慎操作！`:""),Le=r=>{C.value=r.row,I.value=!0},He=()=>{C.value=null},Ie=()=>{el({schemaHistoryId:C.value.id,flowId:p.flowDetail.id}).then(r=>{r&&(V.success("删除成功"),H())}).finally(()=>{I.value=!1,C.value=null})};function Ne(){if(!_("data:flow:publish")){V.error("无权限访问");return}T.value=!0}const T=d(!1),ze=()=>{T.value=!1},Me=()=>{ll({flowId:p.flowDetail.id,componentCode:p.nodeData.id}).then(r=>{r&&(V.success("库变更记录已清空"),H())}).finally(()=>{T.value=!1})};function _e(r){r===2?(h("changeDrawerSize",600),L()):r===3?(h("changeDrawerSize",600),H()):h("resetDrawerSize")}function Be(){return Math.floor(Math.random()*10000001)+11e7}return(r,e)=>{const b=m("t-input"),i=m("t-form-item"),v=m("t-option"),y=m("t-select"),U=m("t-textarea"),x=m("t-input-number"),qe=m("t-switch"),J=m("t-divider"),Oe=m("t-form"),F=m("t-tab-panel"),N=m("t-link"),ee=m("t-alert"),le=m("t-space"),te=m("t-table"),z=m("t-dialog"),Re=m("t-tabs");return f(),$("div",tl,[a(Re,{modelValue:G.value,"onUpdate:modelValue":e[20]||(e[20]=t=>G.value=t),onChange:_e},{default:o(()=>[a(F,{value:1,"destroy-on-hide":!1},{label:o(()=>[...e[21]||(e[21]=[s(" 配置 ",-1)])]),default:o(()=>[e[32]||(e[32]=E("br",null,null,-1)),a(Oe,{ref_key:"form",ref:Z,rules:pe,data:l(n),colon:!0,onReset:j,onSubmit:be},{default:o(()=>[a(i,{label:"名称",name:"name"},{default:o(()=>[a(b,{modelValue:l(n).name,"onUpdate:modelValue":e[0]||(e[0]=t=>l(n).name=t),readonly:l(u)==="publish",placeholder:"请输入内容"},null,8,["modelValue","readonly"])]),_:1}),a(i,{label:"数据源",name:"datasourceCode"},{default:o(()=>[a(y,{readonly:l(u)==="publish",filterable:"",modelValue:l(n).datasourceCode,"onUpdate:modelValue":e[1]||(e[1]=t=>l(n).datasourceCode=t),placeholder:"请选择数据源",style:{width:"100%"}},{default:o(()=>[(f(!0),$(ne,null,re(Q.value,t=>(f(),c(v,{value:t.code,onClick:ae=>W(t),label:t.name},{default:o(()=>[s(k(t.name),1)]),_:2},1032,["value","onClick","label"]))),256))]),_:1},8,["readonly","modelValue"])]),_:1}),l(n).datasourceCode?(f(),c(i,{key:0,label:"监听的库",name:"schemas"},{default:o(()=>[a(y,{readonly:l(u)==="publish",modelValue:l(n).schemas,"onUpdate:modelValue":e[2]||(e[2]=t=>l(n).schemas=t),multiple:"",filterable:"",placeholder:"请选择监听的库"},{default:o(()=>[(f(!0),$(ne,null,re(B.value,t=>(f(),c(v,{value:t.key,label:t.label},{default:o(()=>[s(k(t.label),1)]),_:2},1032,["value","label"]))),256))]),_:1},8,["readonly","modelValue"])]),_:1})):g("",!0),l(n).datasourceCode?(f(),c(i,{key:1,label:"监听的表",name:"tables",help:l(me)!==null?"不允许修改订阅的表，否则请先停止任务清理保存点。":""},{default:o(()=>[a(U,{modelValue:l(n).tables,"onUpdate:modelValue":e[3]||(e[3]=t=>l(n).tables=t),readonly:l(u)==="publish",rows:4,placeholder:"格式：库.表，多个,隔开，支持正则"},null,8,["modelValue","readonly"])]),_:1},8,["help"])):g("",!0),a(i,{label:"操作类型",name:"operations"},{default:o(()=>[a(y,{multiple:"",modelValue:l(n).operations,"onUpdate:modelValue":e[4]||(e[4]=t=>l(n).operations=t),readonly:l(u)==="publish",placeholder:"请选择操作类型",style:{width:"100%"}},{default:o(()=>[a(v,{value:"READ",label:"存量数据"},{default:o(()=>[...e[22]||(e[22]=[s("存量数据",-1)])]),_:1}),a(v,{value:"CREATE",label:"新增"},{default:o(()=>[...e[23]||(e[23]=[s("新增",-1)])]),_:1}),a(v,{value:"UPDATE",label:"更新"},{default:o(()=>[...e[24]||(e[24]=[s("更新",-1)])]),_:1}),a(v,{value:"DELETE",label:"删除"},{default:o(()=>[...e[25]||(e[25]=[s("删除",-1)])]),_:1})]),_:1},8,["modelValue","readonly"])]),_:1}),l(n).datasourceType==="MySQL"?(f(),c(i,{key:2,label:"服务端口",name:"databaseServerId",help:"必须唯一，为空自动生成110000000-120000000随机数"},{default:o(()=>[a(x,{modelValue:l(n).databaseServerId,"onUpdate:modelValue":e[5]||(e[5]=t=>l(n).databaseServerId=t),min:1,max:4294967295,theme:"normal",readonly:l(u)==="publish",placeholder:"请输入"},null,8,["modelValue","readonly"])]),_:1})):g("",!0),l(n).datasourceType==="Oracle"?(f(),c(i,{key:3,label:"监听服务名",name:"listenerServerName"},{default:o(()=>[a(b,{modelValue:l(n).listenerServerName,"onUpdate:modelValue":e[6]||(e[6]=t=>l(n).listenerServerName=t),readonly:l(u)==="publish",placeholder:"XE/ORCLCDB/..."},null,8,["modelValue","readonly"])]),_:1})):g("",!0),a(i,{label:"状态",name:"status"},{default:o(()=>[a(qe,{modelValue:l(n).status,"onUpdate:modelValue":e[7]||(e[7]=t=>l(n).status=t),customValue:["ENABLE","DISABLE"],"before-change":()=>l(u)!=="publish"},null,8,["modelValue","before-change"])]),_:1}),a(i,{label:"批次大小",name:"maxBatchSize"},{default:o(()=>[a(x,{readonly:l(u)==="publish",modelValue:l(n).maxBatchSize,"onUpdate:modelValue":e[8]||(e[8]=t=>l(n).maxBatchSize=t),min:1,max:2e4,placeholder:"请输入最大批次大小"},null,8,["readonly","modelValue"])]),_:1}),a(i,{label:"线程数",name:"threadNumber"},{default:o(()=>[a(x,{readonly:l(u)==="publish",modelValue:l(n).threadNumber,"onUpdate:modelValue":e[9]||(e[9]=t=>l(n).threadNumber=t),min:1,max:20,placeholder:"默认自动根据表数量计算线程使用数"},null,8,["readonly","modelValue"])]),_:1}),l(n).connectionTimeZone?(f(),c(i,{key:4,label:"时区",name:"connectionTimeZone"},{default:o(()=>[a(b,{modelValue:l(n).connectionTimeZone,"onUpdate:modelValue":e[10]||(e[10]=t=>l(n).connectionTimeZone=t),readonly:l(u)==="publish",placeholder:"请输入时区"},null,8,["modelValue","readonly"])]),_:1})):g("",!0),a(J,null,{default:o(()=>[...e[26]||(e[26]=[s("启动策略/保存点",-1)])]),_:1}),a(i,{label:"启动策略",name:"startStrategy"},{default:o(()=>[a(y,{modelValue:l(n).startStrategy,"onUpdate:modelValue":e[11]||(e[11]=t=>l(n).startStrategy=t),readonly:l(u)==="publish",placeholder:"请选择启动策略",style:{width:"100%"}},{default:o(()=>[a(v,{value:"LAST_STORAGE",label:"最新保存点"},{default:o(()=>[...e[27]||(e[27]=[s("最新保存点",-1)])]),_:1}),a(v,{value:"AUTO",label:"自动"},{default:o(()=>[...e[28]||(e[28]=[s("自动",-1)])]),_:1}),a(v,{value:"CUSTOM",label:"指定保存点"},{default:o(()=>[...e[29]||(e[29]=[s("指定保存点",-1)])]),_:1}),a(v,{value:"RECOVERY",label:"恢复模式"},{default:o(()=>[...e[30]||(e[30]=[s("恢复模式",-1)])]),_:1})]),_:1},8,["modelValue","readonly"])]),_:1}),l(n).startStrategy==="CUSTOM"?(f(),c(i,{key:5,label:"保存点",name:"savePoint"},{default:o(()=>[a(b,{readonly:l(u)==="publish",modelValue:l(n).savePoint,"onUpdate:modelValue":e[12]||(e[12]=t=>l(n).savePoint=t),placeholder:"输入保存点编码，从指定保存点继续任务"},null,8,["readonly","modelValue"])]),_:1})):g("",!0),a(i,{label:"保存间隔",name:"savePointInterval"},{default:o(()=>[a(x,{readonly:l(u)==="publish",modelValue:l(n).savePointInterval,"onUpdate:modelValue":e[13]||(e[13]=t=>l(n).savePointInterval=t),min:1e3,max:1e5,placeholder:"请输入"},null,8,["readonly","modelValue"])]),_:1}),a(i,{label:"保留时长",name:"savePointDuration"},{default:o(()=>[a(x,{readonly:l(u)==="publish",modelValue:l(n).savePointDuration,"onUpdate:modelValue":e[14]||(e[14]=t=>l(n).savePointDuration=t),placeholder:"请输入",min:1,max:100},null,8,["readonly","modelValue"])]),_:1}),a(J,null,{default:o(()=>[...e[31]||(e[31]=[s("其他配置",-1)])]),_:1}),a(i,{label:"描述",prop:"description"},{default:o(()=>[a(U,{readonly:l(u)==="publish",modelValue:l(n).description,"onUpdate:modelValue":e[15]||(e[15]=t=>l(n).description=t),rows:4},null,8,["readonly","modelValue"])]),_:1})]),_:1},8,["data"])]),_:1}),a(F,{value:2,"destroy-on-hide":!1},{label:o(()=>[...e[33]||(e[33]=[s(" 保存点 ",-1)])]),default:o(()=>[a(ee,{theme:"info",style:{"margin-top":"10px"}},{message:o(()=>[e[35]||(e[35]=s(" 自动模式下，总是获取最新的一个保存点开始执行，如果没有则按照先存量后增量模式执行。 ",-1)),e[36]||(e[36]=E("br",null,null,-1)),e[37]||(e[37]=s(" 如果启动时不想使用历史保存点，请点击 ",-1)),a(N,{theme:"danger",onClick:Ue},{default:o(()=>[...e[34]||(e[34]=[s("清空",-1)])]),_:1}),e[38]||(e[38]=s(" 保存点。 ",-1))]),_:1}),e[39]||(e[39]=E("br",null,null,-1)),a(te,{data:Y.value,columns:Se.value,"row-key":"id","vertical-align":"top",hover:!0,pagination:w.value,loading:q.value,onPageChange:Ce},{savePoint:o(({row:t})=>[s(k(t.savePoint),1)]),op:o(t=>[a(le,null,{default:o(()=>[l(_)("data:flow:publish")?(f(),c(N,{key:0,theme:"danger",onClick:ae=>Ve(t)},{default:o(()=>[s(k(l(K)("pages.listBase.delete")),1)]),_:1},8,["onClick"])):g("",!0)]),_:2},1024)]),_:1},8,["data","columns","pagination","loading"]),a(z,{width:380,visible:A.value,"onUpdate:visible":e[16]||(e[16]=t=>A.value=t),header:"确认删除当前所选保存点？",body:he.value,"on-cancel":we,onConfirm:De},null,8,["visible","body"]),a(z,{width:380,visible:P.value,"onUpdate:visible":e[17]||(e[17]=t=>P.value=t),header:"清空保存点！",body:"确认清空所有保存点？此操作不可恢复。","on-cancel":Pe,onConfirm:Te},null,8,["visible"])]),_:1}),a(F,{value:3,"destroy-on-hide":!1},{label:o(()=>[...e[40]||(e[40]=[s(" 库变更记录 ",-1)])]),default:o(()=>[a(ee,{theme:"info",style:{"margin-top":"10px"}},{message:o(()=>[e[42]||(e[42]=s(" 记录捕获的数据库结构变更历史。 ",-1)),e[43]||(e[43]=E("br",null,null,-1)),e[44]||(e[44]=s(" 如果启动时遇到不兼容问题，可以先选择使用恢复模式重新执行，如果还存在问题，需要重新同步，可以点击 ",-1)),a(N,{theme:"danger",onClick:Ne},{default:o(()=>[...e[41]||(e[41]=[s("清空",-1)])]),_:1}),e[45]||(e[45]=s(" 。 ",-1))]),_:1}),e[47]||(e[47]=E("br",null,null,-1)),a(te,{data:O.value,columns:Ee.value,"row-key":"id","vertical-align":"top",hover:!0,pagination:S.value,loading:R.value,onPageChange:ke},{schemaLine:o(({row:t})=>[s(k(t.schemaLine),1)]),op:o(t=>[a(le,null,{default:o(()=>[l(_)("data:flow:publish")?(f(),c(N,{key:0,theme:"danger",onClick:ae=>Le(t)},{default:o(()=>[...e[46]||(e[46]=[s(" 删除 ",-1)])]),_:1},8,["onClick"])):g("",!0)]),_:2},1024)]),_:1},8,["data","columns","pagination","loading"]),a(z,{width:380,visible:I.value,"onUpdate:visible":e[18]||(e[18]=t=>I.value=t),header:"删除变更记录？",body:Ae.value,"on-cancel":He,onConfirm:Ie},null,8,["visible","body"]),a(z,{width:380,visible:T.value,"onUpdate:visible":e[19]||(e[19]=t=>T.value=t),header:"清空所有变更记录！",body:"确认清空所有库变更记录？此操作可能会影响正常的同步任务，请谨慎操作！","on-cancel":ze,onConfirm:Me},null,8,["visible"])]),_:1})]),_:1},8,["modelValue"])])}}}),sl=Ze(al,[["__scopeId","data-v-d8aa909f"]]);export{sl as default};
